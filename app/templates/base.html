<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Student Study Dashboard{% endblock %}</title>

    <!-- Global CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sticky_session.css') }}">

    {% block extra_css %}{% endblock %}
  </head>
<body>
  <script>
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
  </script>
  <div id="session-collision-data"
      data-collision='{{ session_collision|tojson | safe if session_collision else "null" }}'>
  </div>




  {% block navbar %}{% endblock %}

    <!--{# ================= ACTIVE STUDY SESSION BAR ================= #}-->
  {% if active_session and active_session.is_active and active_session.started_at <= now %}
    <div
      id="active-session-bar"
      class="active-session-bar"
      data-started-at="{{ active_session.started_at.isoformat() }}"
      data-session-id="{{ active_session.session_id }}"
    >
      <div class="session-bar-left">
        <span class="session-dot"></span>
        <span class="session-title">{{ active_session.title }}</span>
        <span class="session-class">· {{ active_session.class_.class_name }}</span>
      </div>

      <div class="session-bar-center">
        <span class="session-timer" id="session-timer">00:00:00</span>
      </div>

      <div class="session-bar-right">
        <button class="end-session-btn" id="end-session-btn" type="button">End Session</button>
      </div>
    </div>
  {% endif %}

  {% if due_session %}
    {% if active_session %}
      <!-- ================= SESSION COLLISION MODAL ================= -->
      <div id="collision-modal" class="modal-overlay hidden">
        <div class="modal-card">
          <h2>Session Conflict Detected</h2>
          <p>You currently have an active session. Another session is scheduled to start now.</p>

          <div class="modal-actions">
            <button type="button" id="collision-start-now" class="modal-btn confirm-btn">
              Start Scheduled Session
            </button>
            <button type="button" id="collision-cancel" class="modal-btn cancel-btn">
              Cancel Scheduled Session
            </button>
            <button type="button" class="modal-btn open-reschedule-btn" data-session-id="{{ session_collision.scheduled_session_id }}">
              Reschedule
            </button>


          </div>
        </div>
      </div>
    {% else %}
      <!--{# ================= DUE SESSION MODAL ================= #}-->
      <div id="due-session-modal" class="modal-overlay" data-session-id="{{ due_session.session_id }}" data-session-title="{{ due_session.title}}">
        <div class="modal-card">
          <h2>Study Session Started</h2>
          <p>Your "{{ due_session.title }}" session for the "{{ due_session.class_.class_name }}" class has started. What would you like to do?</p>

          <div class="modal-actions">
            <button type="button" id="start-now-btn" class="modal-btn confirm-btn">Start Now</button>
            <button type="button" id="cancel-session-btn" class="modal-btn cancel-btn">Cancel</button>
            <button type="button" id="reschedule-btn" class="modal-btn">Reschedule</button>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}


  <!-- ================= RESCHEDULE MODAL ================= -->
  <div id="reschedule-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>Reschedule Study Session</h2>
      <p id="reschedule-session-title"></p>
      <label for="reschedule-datetime">New Date & Time</label>
      <input
        type="datetime-local"
        id="reschedule-datetime"
        required
      />

      <div class="modal-actions">
        <button type="button" id="cancel-reschedule" class="modal-btn cancel-btn">
          Cancel
        </button>
        <button type="button" id="confirm-reschedule" class="modal-btn confirm-btn">
          Reschedule
        </button>
      </div>
    </div>
  </div>

  <!-- ================= RESCHEDULE ERROR MODAL ================= -->
  <div id="reschedule-error-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h3>Invalid Date</h3>
      <p>Please make sure your rescheduled date is set in the future.</p>

      <div class="modal-actions">
        <button type="button" id="close-reschedule-error" class="modal-btn confirm-btn">
          OK
        </button>
      </div>
    </div>
  </div>


  <!--{# ================= FLASH MESSAGES ================= #}-->
  <div class="flash-messages">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-list">
          {% for message in messages %}
            <li class="flash-item">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
  </div>

  <main>
    {% block content %}{% endblock %}

    <!-- ================= END SESSION MODAL ================= #}-->
    <div id="end-session-modal" class="modal-overlay hidden">
      <div class="modal-card">
        <h2>End Study Session</h2>
        <p>Are you sure you want to end this study session?</p>
        <div class="modal-actions">
          <button type="button" id="cancel-end-session" class="modal-btn cancel-btn">Cancel</button>
          <button type="button" id="confirm-end-session" class="modal-btn confirm-btn">End Session</button>
        </div>
      </div>
    </div>

    <!-- ================= CLASS CODE ERROR MODAL ================= -->
    <div id="class-code-error-modal" class="modal-overlay hidden">
      <div class="modal-card">
        <h3>Class Code Already Exists</h3>
        <p id="class-code-error-text"></p>

        <div class="modal-actions">
          <button type="button" id="close-class-code-error" class="modal-btn confirm-btn">
            OK
          </button>
        </div>
      </div>
    </div>



    <!-- ================= ADD CLASS MODAL ================= -->
    <div class="modal-overlay hidden" data-modal-class="active" id="addClassModal">
      <div class="modal card">
          <h2 id="classModalTitle">Add Class</h2>
          <form method="POST" action="{{ url_for('classes.add_class') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <label for="class-name" class="input-label">Class Name</label>
              <input
                  id="class-name"
                  type="text"
                  name="class_name"
                  class="input-field"
                  required
              >

              <label for="class-code" class="input-label">Class Code</label>
              <input
                  id="class-code"
                  type="text"
                  name="class_code"
                  class="input-field"
                  placeholder="e.g. MATH101"
                  required
              >

              <label for="classTypeSelect" class="input-label">Class Type</label>
              <select id="classTypeSelect" name="class_type" class="input-field" required>
                  <option value="">Select Class Type</option>
                  <option value="math">Math</option>
                  <option value="science">Science</option>
                  <option value="language">Language</option>
                  <option value="social_science">Social Science</option>
                  <option value="art">Art</option>
                  <option value="engineering">Engineering</option>
                  <option value="technology">Technology</option>
                  <option value="finance">Finance</option>
                  <option value="other">Other</option>
              </select>

              <label for="classColor" class="input-label">
                  Class Color
                  <span class="hint">(used for charts & calendar)</span>
              </label>

              <div class="color-picker-row">
                  <input
                      id="classColor"
                      type="color"
                      name="color"
                      class="color-input"
                      value="#4f46e5"
                  >
                  <span class="color-preview-text">Click to choose a color</span>
              </div>
              <!-- ===== ADVANCED OPTIONS TOGGLE ===== -->
              <button
                  type="button"
                  class="advanced-toggle"
                  aria-expanded="false"
              >
                  ▸ Advanced options
              </button>

              <div class="advanced-options hidden">
                  <!-- Teacher Name -->
                  <label class="input-label">
                      Teacher Name
                      <span class="hint-icon"
                          data-hint="Optional. Helps you remember who teaches this class, especially if you have multiple classes with similar names.">
                          ?
                      </span>
                  </label>
                  <input
                      id="teacher_name"
                      type="text"
                      name="teacher_name"
                      class="input-field"
                      placeholder="e.g. Mr. Smith"
                  />

                  <!-- Importance -->
                  <label class="input-label">
                      Importance
                      <span class="hint-icon" data-hint="How important this class is compared to your others. Used for prioritization and analytics.">?</span>
                  </label>
                  <select id="importance" name="importance" class="input-field">
                      <option value="">Not set</option>
                      <option value="high">High</option>
                      <option value="medium">Medium</option>
                      <option value="low">Low</option>
                  </select>

                  <!-- Difficulty -->
                  <label class="input-label">
                      Difficulty
                      <span class="hint-icon" data-hint="How hard this class feels to you overall. You can change this later.">?</span>
                  </label>
                  <input
                      id="difficulty"
                      type="number"
                      name="difficulty"
                      class="input-field"
                      min="1"
                      max="10"
                      placeholder="1 (easy) – 10 (very hard)"
                  >

                  <!-- Pass Grade -->
                  <label class="input-label">
                      Pass Grade (%)
                      <span class="hint-icon" data-hint="The minimum grade you personally consider a passing grade for this class.">?</span>
                  </label>
                  <input
                      id="pass_grade"
                      type="number"
                      name="pass_grade"
                      class="input-field"
                      min="0"
                      max="100"
                      step="0.1"
                      placeholder="e.g. 60"
                  >
              </div>


              <div class="modal-actions">
                  <button type="submit" class="btn full-btn" id="classModalSubmit">
                      Create Class
                  </button>
                  <button type="button" class="btn ghost-btn" data-close-modal id="closeAddClassModal">
                      Cancel
                  </button>
              </div>
          </form>

      </div>
  </div>

  </main>

  <!-- Global JS -->
  <script src="{{ url_for('static', filename='vendor/chart.umd.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sticky_session.js') }}"></script>
  {% block extra_js %}{% endblock %}
  </body>
</html>
