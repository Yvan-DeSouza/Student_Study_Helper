{% extends "base.html" %}
{% block title %}Assignments | StudyMate{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/assignments.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}">
{% endblock %}

{% block navbar %}

<nav class="navbar card">
    <div class="nav-left">
        <img src="{{ url_for('static', filename='images/study_logo.png') }}" class="nav-logo" alt="StudyMate logo">
        <span class="brand-name">StudyMate</span>
    </div>


<div class="nav-center">
    <a href="{{ url_for('main.home') }}" class="nav-link">Home</a>
    <a href="{{ url_for('classes.list_classes') }}" class="nav-link">Classes</a>
    <a href="{{ url_for('assignment.list_assignments') }}" class="nav-link active">Assignments</a>
    <a href="{{ url_for('study.study_sessions') }}" class="nav-link">Study Sessions</a>
    <a href="{{ url_for('dashboard.graphs') }}" class="nav-link">Dashboard</a>
    <a href="{{ url_for('calendar.home') }}" class="nav-link">Calendar</a>
</div>

<div class="nav-right">
    <a href="{{ url_for('auth.logout') }}" class="logout-link">Logout</a>
    <div class="user-avatar">
        <img src="{{ url_for('static', filename='images/user_avatar.png') }}" alt="User avatar">
    </div>
    <button class="theme-toggle" aria-label="Toggle theme">
        <span class="toggle-icon">‚òÄÔ∏è</span>
    </button>
</div>

</nav>
{% endblock %}

{% block content %}

<div class="assignments-container">


<!-- ================= TOP ACTIONS ================= -->
<section class="assignments-top card">
    <div class="top-left">
        <h1>Your Assignments</h1>
        <p class="muted">Track deadlines, grades, and completion</p>
    </div>
    <div class="top-right">
        <button class="btn-tiny" data-open-modal="addAssignmentModal">+ Add Assignment</button>
    </div>
</section>

<!-- ================= REMINDERS ================= -->
<section class="assignments-reminders">
    <div class="card upcoming-deadlines">
        <h3>Upcoming Deadlines</h3>
        <ul class="deadline-list">
            <!-- JS inject upcoming assignments -->
            <li class="placeholder">No upcoming deadlines</li>
        </ul>
    </div>

    <div class="card calendar-preview">
        <h3>This Month</h3>
        <div class="calendar-grid">
            <!-- Calendar scaffold only -->
        </div>
    </div>
</section>

<!-- ================= FILTER PANEL ================= -->
<section class="assignments-filters card">
    <div class="filter-group">
        <label for="dueFilter" class="input-label">Due Status</label>
        <select id="dueFilter" name="due_status" class="input-field">
            <option value="all">All</option>
            <option value="overdue">Overdue</option>
            <option value="not_due">Not Due</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="completionFilter" class="input-label">Completion</label>
        <select id="completionFilter" name="completion" class="input-field">
            <option value="all">All</option>
            <option value="completed">Completed</option>
            <option value="uncompleted">Uncompleted</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="gradedFilter" class="input-label">Graded</label>
        <select id="gradedFilter" name="graded" class="input-field">
            <option value="all">All</option>
            <option value="graded">Graded</option>
            <option value="not_graded">Not Graded</option>
        </select>
    </div>

    <fieldset class="filter-group wide">
        <legend class="input-label">Assignment Type</legend>

        <div class="checkbox-row">

            <label for="type-homework">
                <input type="checkbox" id="type-homework" name="assignment_type" value="homework" checked>
                Homework
            </label>

            <label for="type-test">
                <input type="checkbox" id="type-test" name="assignment_type" value="test" checked>
                Test
            </label>

            <label for="type-quiz">
                <input type="checkbox" id="type-quiz" name="assignment_type" value="quiz" checked>
                Quiz
            </label>

            <label for="type-project">
                <input type="checkbox" id="type-project" name="assignment_type" value="project" checked>
                Project
            </label>

            <label for="type-lab-report">
                <input type="checkbox" id="type-lab-report" name="assignment_type" value="lab_report" checked>
                Lab Report
            </label>

            <label for="type-essay">
                <input type="checkbox" id="type-essay" name="assignment_type" value="essay" checked>
                Essay
            </label>

            <label for="type-exam">
                <input type="checkbox" id="type-exam" name="assignment_type" value="exam" checked>
                Exam
            </label>

            <label for="type-other">
                <input type="checkbox" id="type-other" name="assignment_type" value="other" checked>
                Other
            </label>

        </div>
    </fieldset>


    <div class="filter-group">
        <label for="tableMode" class="input-label">Table Mode</label>
        <select id="tableMode" name="table_mode" class="input-field">
            <option value="single">Single Table</option>
            <option value="per_class">One Table per Class</option>
        </select>
    </div>
</section>




<!-- ================= Table ================= -->
{% set assignments_by_class = {} %}
{% for a in assignments %}
    {% if a.class_name not in assignments_by_class %}
        {% set _ = assignments_by_class.update({a.class_name: []}) %}
    {% endif %}
    {% set _ = assignments_by_class[a.class_name].append(a) %}
{% endfor %}
<section class="assignments-table-wrapper">



    <!-- ===== SINGLE TABLE MODE ===== -->
    <div class="card assignments-table-card" data-table-mode="single">
        <div class="table-actions">
            <button class="btn-tiny table-edit-btn">‚úè Edit</button>
            <button class="btn-tiny danger table-delete-btn" >üóë Delete</button>
        </div>

        {% set rows = assignments %}
        {% set show_class_column = true %}
        {% include "partials/assignments_table.html" %}
    </div>


    <!-- ===== PER CLASS MODE ===== -->
    <div class="per-class-wrapper hidden" data-table-mode="per_class">
        {% for class_name, rows in assignments_by_class.items() %}
        <div class="card assignments-table-card per-class-card">
            <h3 class="class-table-title">{{ class_name }}</h3>

            <div class="table-actions">
                <button class="btn-tiny table-edit-btn">‚úè Edit</button>
                <button class="btn-tiny danger table-delete-btn">üóë Delete</button>
            </div>
            {% set rows = rows %}
            {% set show_class_column = false %}
            {% include "partials/assignments_table.html" %}
        </div>
        {% endfor %}
    </div>

</section>






<!-- ================= ANALYTICS ================= -->
<section class="assignments-analytics">
    <div class="card chart-card">
        <h3>Completion Breakdown</h3>
        <div class="chart-toggle">
            <button class="btn-tiny active">Simple</button>
            <button class="btn-tiny">Detailed</button>
        </div>
        <canvas id="assignmentCompletionChart"></canvas>
    </div>

    <div class="card chart-card">
        <h3>Grade Distribution</h3>
        <canvas id="assignmentGradeChart"></canvas>
    </div>
</section>


</div>


<!--Edit Assignment Modal-->

<div class="modal-overlay" id="editAssignmentModal">
    <div class="modal card">
        <h2>Edit Assignment</h2>

        <form id="editAssignmentForm">
            <input type="hidden" id="edit-assignment-id">

            <!-- Class -->
            <label for="edit-class" class="input-label">Class</label>
            <select id="edit-class" class="input-field"></select>

            <!-- Title -->
            <label for="edit-title"class="input-label">Title</label>
            <input id="edit-title" type="text" class="input-field" required>

            <!-- Type -->
            <label for="edit-type" class="input-label">Type</label>
            <select id="edit-type" class="input-field"></select>

            <!-- Due -->
            <label for="edit-due-at" class="input-label">Due Date</label>
            <input id="edit-due-at" type="datetime-local" class="input-field">

            <!-- Finished At -->
            <label for="edit-finished-at" class="input-label">Finish Date (Optional)</label>
            <input id="edit-finished-at" type="datetime-local" class="input-field">

            <!-- Graded -->
            <div class="checkbox-row">
                <input type="checkbox" id="edit-is-graded">
                <label for="edit-is-graded">This assignment is graded</label>
            </div>

            <!-- Advanced -->
            <button type="button" class="advanced-toggle">‚ñ∏ Advanced options</button>

            <div class="advanced-options hidden">
                <label for="edit-difficulty" class="input-label">Difficulty
                    <span class="hint-icon" data-hint="How difficult this assignment is expected to be.">?</span>
                </label>
                <input id="edit-difficulty" type="number" class="input-field" min="1" max="10" placeholder="1 (easy) ‚Äì 10 (hard)">

                <label for="edit-estimated-minutes" class="input-label">Estimated Minutes
                    <span class="hint-icon" data-hint="Estimated time to complete this assignment.">?</span>
                </label>
                <input id="edit-estimated-minutes" type="number" class="input-field" min="1" placeholder="e.g. 45">

                <div id="edit-graded-only" class="hidden">
                    <label for="edit-expected-grade" class="input-label">Expected Grade in % (Optional)
                        <span class="hint-icon" data-hint="What grade do you expect to get for this assignment.">?</span>
                    </label>
                    <input id="edit-expected-grade" type="number" class="input-field" min="0" max="100" >

                    <label for="edit-pass-grade" class="input-label">Pass Grade in % (Optional)
                        <span class="hint-icon" data-hint="Minimum grade considered passing.">?</span>
                    </label>
                    <input id="edit-pass-grade" type="number" class="input-field" min="0" max="100">

                    <label for="edit-ponderation" class="input-label">Ponderation, from 1-5 (Optional)
                        <span class="hint-icon" data-hint="What is the relative weight of this assignment compared to others.">?</span>
                    </label>
                    <input id="edit-ponderation" type="number" class="input-field" min="1" max="5">
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn full-btn">Confirm</button>
                <button type="button" class="btn ghost-btn" data-close-modal>Cancel</button>
            </div>
        </form>
    </div>
</div>









<!-- ================= ADD ASSIGNMENT MODAL ================= -->
<div class="modal-overlay" id="addAssignmentModal" >
    <div class="modal card">
        <h2>Add Assignment</h2>
        <form method="POST" action="{{ url_for('assignment.add_assignment') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Mandatory: Class & Assignment Name -->
            <label for="assignment-class" class="input-label">Class</label>
            <select id="assignment-class" name="class_id" class="input-field" required>
                {% for c in classes %}
                <option value="{{ c.class_id }}">{{ c.class_name }}</option>
                {% endfor %}
            </select>

            <label for="assignment-title" class="input-label">Assignment Name</label>
            <input
                id="assignment-title"
                type="text"
                name="assignment_title"
                class="input-field"
                required
            >

            <!-- Mandatory: Assignment Type -->
            <label for="assignment-type" class="input-label">Assignment Type</label>
            <select id="assignment-type" name="assignment_type" class="input-field">
                <option value="homework">Homework</option>
                <option value="project">Project</option>
                <option value="quiz">Quiz</option>
                <option value="essay">Essay</option>
                <option value="test">Test</option>
                <option value="exam">Exam</option>
                <option value="lab_report">Lab Report</option>
                <option value="other">Other</option>
            </select>

            <!-- Optional: Due Date -->
            <label for="due_at" class="input-label">Due Date (Optional) <span class="hint">(optional)</span></label>
            <input
                id="due_at"
                type="datetime-local"
                name="due_at"
                class="input-field"
            >

            <!-- ===== GRADED CHECKBOX ===== -->
            <div class="checkbox-row">
                <input
                    type="checkbox"
                    id="is-graded"
                    name="is_graded"
                    class="checkbox-input"
                    data-toggle-checkbox="graded-options-container"
                >
                <label for="is-graded" class="checkbox-label">
                    <span class="checkbox-box"></span>
                    This assignment is graded
                </label>
            </div>

            <!-- Advanced Options Toggle -->
            <button type="button" class="advanced-toggle">‚ñ∏ Advanced options</button>
            <div class="advanced-options hidden"> 
                <!-- Ponderation & Pass Grade (conditional) -->
                <div id="graded-options-container" class="graded-options hidden">
                    <label for="add-expected-grade" class="input-label">Expected Grade</label>
                    <input id="add-expected-grade" type="number" class="input-field" min="0" max="100">
                    <label for="ponderation" class="input-label">
                        Ponderation, from 1‚Äì5 (Optional)
                        <span class="hint-icon" data-hint="What is the relative weight of this assignment compared to others.">?</span>
                    </label>
                    <input
                        id="ponderation"
                        type="number"
                        name="ponderation"
                        class="input-field"
                        min="1"
                        max="5"
                    >

                    <label for="pass_grade" class="input-label">
                        Pass Grade in % (Optional)
                        <span class="hint-icon" data-hint="Minimum grade considered passing.">?</span>
                    </label>
                    <input
                        id="pass_grade"
                        type="number"
                        name="pass_grade"
                        class="input-field"
                        min="0"
                        max="100"
                        step="0.1"
                    >
                </div>

                <!-- Optional fields -->
                <label for="difficulty" class="input-label">Difficulty (Optional)
                    <span class="hint-icon" data-hint="How difficult this assignment is expected to be.">?</span>
                </label>
                <input
                    type="number"
                    name="difficulty"
                    class="input-field"
                    min="1"
                    max="10"
                    placeholder="1 (easy) ‚Äì 10 (hard)"
                > 

                <div class="input-row">
                    <label for="estimated_minutes" class="input-label">Estimated Time (optional)
                        <span class="hint-icon" data-hint="Estimated time to complete this assignment.">?</span>
                    </label>
                    <input
                        id="estimated_minutes"
                        type="number"
                        name="estimated_minutes"
                        class="input-field"
                        min="1"
                        placeholder="e.g. 45"
                    >
                </div>
            </div> 

            <div class="modal-actions">
                <button type="submit" class="btn full-btn">Save</button>
                <button type="button" class="btn ghost-btn" data-close-modal>Cancel</button>
            </div>
        </form>
    </div>
</div>


<!-- ================= FUTURE FINISH DATE WARNING MODAL ================= -->
<div class="modal-overlay hidden" id="futureFinishDateModal">
    <div class="modal card">
        <h2>Invalid Finish Date</h2>

        <p class="modal-message">
            Please make sure to enter a finish date that has already passed
            (no finish date that is in the future is allowed).
        </p>

        <div class="modal-actions">
            <button
                type="button"
                class="btn full-btn"
                data-close-modal
            >
                Ok
            </button>
        </div>
    </div>
</div>


<!-- Uncomplete confirmation modal-->
<div class="modal-overlay hidden" id="uncompleteConfirmModal">
    <div class="modal card">
        <h2>Mark as Uncompleted</h2>

        <p class="modal-message" id="uncompleteMessage"></p>

        <div class="modal-actions">
        <button class="btn danger" id="confirmUncomplete">Confirm</button>
        <button class="btn ghost-btn" data-close-modal>Cancel</button>
        </div>
    </div>
</div>



<!-- Complete assignment modal -->
 <div class="modal-overlay hidden" id="completeAssignmentModal">
  <div class="modal card">
    <h2>Mark as Completed</h2>

    <p class="modal-message" id="completeMessage"></p>

    <fieldset class="radio-group">
      <label>
        <input type="radio" name="completion_time" value="now" checked>
        Now
      </label>

      <label>
        <input type="radio" name="completion_time" value="pick">
        Pick a date
      </label>

      <input
        type="datetime-local"
        id="pickedCompletionDate"
        class="input-field hidden"
      >

      <label id="dueDateOption" class="hidden">
        <input type="radio" name="completion_time" value="due">
        Due date
      </label>
    </fieldset>

    <div class="modal-actions">
      <button class="btn full-btn" id="confirmComplete">Confirm</button>
      <button class="btn ghost-btn" data-close-modal>Cancel</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/form.js') }}"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="{{ url_for('static', filename='js/assignments.js') }}"></script>
<script src="{{ url_for('static', filename='js/constants.js') }}"></script>

{% endblock %}
